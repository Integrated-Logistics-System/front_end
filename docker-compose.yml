# ğŸš€ Nginx + Frontend Docker Compose (í”„ë¡œë•ì…˜ ìµœì í™”)
version: '3.8'

services:
  # Nginx ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ & ë¡œë“œë°¸ëŸ°ì„œ
  nginx:
    image: nginx:1.25-alpine
    container_name: recipe-ai-nginx
    ports:
      - "81:80"      # HTTP
      - "443:443"    # HTTPS (í–¥í›„ SSL ì ìš©)
    volumes:
      # Nginx ì„¤ì • íŒŒì¼
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      
      # Static íŒŒì¼ ì§ì ‘ ì„œë¹™ (ì„±ëŠ¥ ìµœì í™”)
      - ./nginx/static:/usr/share/nginx/html/static:ro
      
      # ë¡œê·¸ ì €ì¥
      - ./nginx/logs:/var/log/nginx
      
      # SSL ì¸ì¦ì„œ (í–¥í›„ ì‚¬ìš©)
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    
    environment:
      # Nginx ìµœì í™” ì„¤ì •
      NGINX_WORKER_PROCESSES: auto
      NGINX_WORKER_CONNECTIONS: 1024
    
    depends_on:
      - frontend
      - wait-for-backend
    
    restart: unless-stopped
    
    networks:
      - recipe-ai-network
    
    # Nginx í—¬ìŠ¤ì²´í¬
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Next.js Frontend
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: recipe-ai-frontend
    # ğŸ”¥ í¬íŠ¸ë¥¼ ë‚´ë¶€ë¡œë§Œ ë…¸ì¶œ (Nginxë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼)
    expose:
      - "3000"
    environment:
      NODE_ENV: production
      
      # API ì—°ê²° (Nginxë¥¼ í†µí•´ í”„ë¡ì‹œ)
      NEXT_PUBLIC_API_URL: http://nginx/api
      NEXT_PUBLIC_WS_URL: ws://nginx/ws
      
      NEXT_TELEMETRY_DISABLED: 1
    
    restart: unless-stopped
    
    networks:
      - recipe-ai-network
    
    # í—¬ìŠ¤ì²´í¬
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ë°±ì—”ë“œ ëŒ€ê¸°ìš©
  wait-for-backend:
    image: busybox:1.35
    container_name: wait-for-backend
    command: |
      sh -c "
        echo 'â³ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸° ì¤‘...'
        
        # Backend API ëŒ€ê¸°
        until nc -z 192.168.0.111 8081; do
          echo 'ğŸ”— Backend API ì—°ê²° ëŒ€ê¸°...'
          sleep 3
        done
        echo 'âœ… Backend API ì—°ê²° í™•ì¸'
        
        # WebSocket ëŒ€ê¸°
        until nc -z 192.168.0.111 8083; do
          echo 'ğŸ”Œ WebSocket ì—°ê²° ëŒ€ê¸°...'
          sleep 3
        done
        echo 'âœ… WebSocket ì—°ê²° í™•ì¸'
        
        echo 'ğŸš€ ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì¤€ë¹„ ì™„ë£Œ!'
      "
    networks:
      - recipe-ai-network

networks:
  recipe-ai-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.31.0.0/16

# ğŸ¯ ì‚¬ìš©ë²•:
# docker-compose up -d          # ì „ì²´ ì‹œì‘
# docker-compose logs nginx -f  # Nginx ë¡œê·¸ í™•ì¸
# docker-compose restart nginx  # Nginxë§Œ ì¬ì‹œì‘
