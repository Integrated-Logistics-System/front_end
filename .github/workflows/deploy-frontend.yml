name: Build and Deploy Frontend to Synology

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # CI ì‘ì—…: ì½”ë“œ í’ˆì§ˆ ê²€ì¦
  quality-checks:
    runs-on: self-hosted
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run TypeScript type check
        run: npm run type-check
        
      - name: Run ESLint
        run: npm run lint
        
      - name: Build project
        run: npm run build

  # CD ì‘ì—…: ë©”ì¸ ë¸Œëœì¹˜ì—ë§Œ ë°°í¬
  build-and-deploy:
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: quality-checks
    runs-on: self-hosted

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° Docker Composeë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
      - name: Clean up and deploy frontend
        run: |
          # GitHub Secret(ENV_FILE_FRONTEND)ì˜ ë‚´ìš©ì„ .env.local íŒŒì¼ë¡œ ìƒì„±
          echo "${{ secrets.ENV_FILE_FRONTEND }}" > ./.env.local

          # í•„ìš”í•œ ë””ë ‰í„°ë¦¬ ìƒì„±
          mkdir -p ./nginx/logs
          mkdir -p ./nginx/static

          # ì´ë¯¸ì§€ ë²„ì „ ì„¤ì • (Git ì»¤ë°‹ í•´ì‹œ ì‚¬ìš©)
          export IMAGE_TAG=${GITHUB_SHA:0:7}
          echo "Building frontend with image tag: $IMAGE_TAG"

          # ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì—ëŸ¬ ë¬´ì‹œ)
          docker stop recipe-ai-nginx recipe-ai-frontend wait-for-backend 2>/dev/null || true
          docker rm recipe-ai-nginx recipe-ai-frontend wait-for-backend 2>/dev/null || true

          # ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³ , ì—†ìœ¼ë©´ ë¹Œë“œ
          if ! docker image inspect recipe-ai-frontend:$IMAGE_TAG >/dev/null 2>&1; then
            echo "Building new frontend image: recipe-ai-frontend:$IMAGE_TAG"
            docker compose build --build-arg IMAGE_TAG=$IMAGE_TAG
            docker tag recipe-ai-frontend:latest recipe-ai-frontend:$IMAGE_TAG
          else
            echo "Using existing frontend image: recipe-ai-frontend:$IMAGE_TAG"
            docker tag recipe-ai-frontend:$IMAGE_TAG recipe-ai-frontend:latest
          fi

          # Docker Composeë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘
          docker compose down --remove-orphans
          docker compose up -d

          # ì˜¤ë˜ëœ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœê·¼ 5ê°œ ë²„ì „ë§Œ ìœ ì§€)
          docker images recipe-ai-frontend --format "table {{.Tag}}\t{{.CreatedAt}}" | tail -n +2 | sort -k2 -r | tail -n +6 | awk '{print $1}' | grep -v latest | xargs -r -I {} docker rmi recipe-ai-frontend:{} 2>/dev/null || true

      # 3. ë°±ì—”ë“œ ì„œë¹„ìŠ¤ ì—°ê²° ëŒ€ê¸° ë° í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ í™•ì¸
      - name: Verify frontend is running
        run: |
          echo "Waiting for backend services to be ready..."
          sleep 30 # ë°±ì—”ë“œ ëŒ€ê¸° ì‹œê°„

          echo "Checking running containers:"
          docker compose ps

          echo "Testing frontend endpoint:"
          # Nginx í”„ë¡ì‹œë¥¼ í†µí•œ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          timeout 60 bash -c 'until wget --spider --quiet http://localhost:81; do echo "Waiting for frontend..."; sleep 5; done' || (echo "\n--- Frontend check failed. Displaying container logs: ---" && docker compose logs && exit 1)

          echo "Testing backend API through frontend proxy:"
          # í”„ë¡ íŠ¸ì—”ë“œë¥¼ í†µí•œ ë°±ì—”ë“œ API í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸
          timeout 30 bash -c 'until wget --spider --quiet http://localhost:81/api/auth/health; do echo "Waiting for API proxy..."; sleep 3; done' || echo "API proxy test failed (non-critical)"

          echo "âœ… Frontend deployment successful!"
          echo "ğŸŒ Frontend URL: http://[ë‚˜ìŠ¤IP]:81"
          echo "ğŸ“¡ API Proxy: http://[ë‚˜ìŠ¤IP]:81/api"

      # 4. ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Deployment notification
        run: |
          echo "ğŸ‰ Frontend deployment completed successfully!"
          echo "ğŸ“Š Container Status:"
          docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"