name: Build and Deploy Frontend to Synology

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # CI ì‘ì—…: ì½”ë“œ í’ˆì§ˆ ê²€ì¦
  quality-checks:
    runs-on: self-hosted
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: package-lock.json
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run TypeScript type check
        run: npm run type-check
        
      - name: Run ESLint
        run: npm run lint
        
      - name: Build project
        run: npm run build

  # CD ì‘ì—…: ë°°í¬
  build-and-deploy:
    needs: quality-checks
    runs-on: self-hosted

    steps:
      # 1. ì†ŒìŠ¤ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v4

      # 2. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ë° Docker Composeë¡œ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬
      - name: Clean up and deploy frontend
        run: |
          # GitHub Secret(ENV_FILE_FRONTEND)ì˜ ë‚´ìš©ì„ .env.local íŒŒì¼ë¡œ ìƒì„±
          echo "${{ secrets.ENV_FILE_FRONTEND }}" > ./.env.local

          # í•„ìš”í•œ ë””ë ‰í„°ë¦¬ ìƒì„±
          mkdir -p ./nginx/logs
          mkdir -p ./nginx/static

          # ì´ë¯¸ì§€ ë²„ì „ ì„¤ì • (Git ì»¤ë°‹ í•´ì‹œ ì‚¬ìš©)
          export IMAGE_TAG=${GITHUB_SHA:0:7}
          echo "Building frontend with image tag: $IMAGE_TAG"

          # ë¡œì»¬í˜¸ìŠ¤íŠ¸ ë°±ì—”ë“œ ì‚¬ìš©ì„ ìœ„í•œ ë¡œì»¬ êµ¬ì„± ì‚¬ìš©
          echo "Using localhost backend configuration..."

          # ê¸°ì¡´ í”„ë¡ íŠ¸ì—”ë“œ ì»¨í…Œì´ë„ˆ ì •ë¦¬ (ì—ëŸ¬ ë¬´ì‹œ)
          docker stop recipe-ai-nginx-local recipe-ai-frontend-local 2>/dev/null || true
          docker rm recipe-ai-nginx-local recipe-ai-frontend-local 2>/dev/null || true

          # Docker Composeë¡œ í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ì‹œì‘ (ë¡œì»¬ êµ¬ì„±)
          docker compose -f docker-compose.local.yml down --remove-orphans
          docker compose -f docker-compose.local.yml build --build-arg IMAGE_TAG=$IMAGE_TAG
          docker compose -f docker-compose.local.yml up -d

          # ì˜¤ë˜ëœ í”„ë¡ íŠ¸ì—”ë“œ ì´ë¯¸ì§€ ì •ë¦¬ (ìµœê·¼ 5ê°œ ë²„ì „ë§Œ ìœ ì§€)
          docker images recipe-ai-frontend --format "table {{.Tag}}\t{{.CreatedAt}}" | tail -n +2 | sort -k2 -r | tail -n +6 | awk '{print $1}' | grep -v latest | xargs -r -I {} docker rmi recipe-ai-frontend:{} 2>/dev/null || true

      # 3. ë¡œì»¬ ë°±ì—”ë“œ ì—°ê²° í™•ì¸ ë° í”„ë¡ íŠ¸ì—”ë“œ ì„œë¹„ìŠ¤ ê²€ì¦
      - name: Verify frontend is running
        run: |
          echo "Checking localhost backend services..."
          # ë¡œì»¬ ë°±ì—”ë“œ API í™•ì¸
          if nc -z localhost 8081; then
            echo "âœ… Backend API (localhost:8081) is running"
          else
            echo "âš ï¸ Backend API (localhost:8081) is not running"
          fi
          
          # ë¡œì»¬ WebSocket í™•ì¸  
          if nc -z localhost 8083; then
            echo "âœ… WebSocket (localhost:8083) is running"
          else
            echo "âš ï¸ WebSocket (localhost:8083) is not running"
          fi

          echo "Waiting for frontend services to be ready..."
          sleep 20

          echo "Checking running containers:"
          docker compose -f docker-compose.local.yml ps

          echo "Testing frontend endpoint:"
          # Nginx í”„ë¡ì‹œë¥¼ í†µí•œ í”„ë¡ íŠ¸ì—”ë“œ ì ‘ê·¼ í…ŒìŠ¤íŠ¸
          timeout 60 bash -c 'until wget --spider --quiet http://localhost:80; do echo "Waiting for frontend..."; sleep 5; done' || (echo "\n--- Frontend check failed. Displaying container logs: ---" && docker compose -f docker-compose.local.yml logs && exit 1)

          echo "Testing backend API through frontend proxy:"
          # í”„ë¡ íŠ¸ì—”ë“œë¥¼ í†µí•œ ë°±ì—”ë“œ API í”„ë¡ì‹œ í…ŒìŠ¤íŠ¸ (ë¡œì»¬í˜¸ìŠ¤íŠ¸)
          timeout 30 bash -c 'until wget --spider --quiet http://localhost:80/api/auth/health; do echo "Waiting for API proxy..."; sleep 3; done' || echo "API proxy test failed (non-critical - check if backend is running locally)"

          echo "âœ… Frontend deployment successful!"
          echo "ğŸŒ Frontend URL: http://localhost"
          echo "ğŸ“¡ API Proxy: http://localhost/api (â†’ localhost:8081/api)"
          echo "ğŸ”Œ WebSocket Proxy: ws://localhost/ws (â†’ localhost:8083)"

      # 4. ë°°í¬ ì„±ê³µ ì•Œë¦¼
      - name: Deployment notification
        run: |
          echo "ğŸ‰ Localhost Frontend deployment completed successfully!"
          echo "ğŸ“Š Container Status:"
          docker compose -f docker-compose.local.yml ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
          echo ""
          echo "ğŸ”— Service URLs:"
          echo "  Frontend: http://localhost"
          echo "  API Proxy: http://localhost/api â†’ localhost:8081/api"
          echo "  WebSocket: ws://localhost/ws â†’ localhost:8083"