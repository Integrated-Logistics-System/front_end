name: Deploy Frontend

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Debug Environment Variables
      run: |
        echo "ğŸ” Checking frontend environment..."
        echo "Working directory: $(pwd)"
        echo "Current user: $(whoami)"
        echo ""
        echo "ğŸ“ Files in current directory:"
        ls -la
        echo ""
        echo "ğŸ“„ Environment files:"
        echo "--- .env files ---"
        for env_file in .env .env.local .env.production .env.development; do
          if [ -f "$env_file" ]; then
            echo "âœ… $env_file found"
            echo "Content of $env_file (secrets masked):"
            sed 's/=.*/=***MASKED***/' "$env_file"
            echo ""
          else
            echo "âŒ $env_file not found"
          fi
        done
        echo ""
        echo "ğŸ³ Docker compose configuration:"
        docker compose config
        echo ""
        echo "ğŸ”§ Dockerfile check:"
        if [ -f Dockerfile ]; then
          echo "âœ… Dockerfile found"
          head -20 Dockerfile
        else
          echo "âŒ Dockerfile not found"
        fi

    - name: Deploy with Docker Compose
      run: |
        echo "ğŸš€ Deploying frontend..."
        docker compose up -d
        echo "âœ… Frontend deployment completed"

    - name: Health Check
      run: |
        echo "ğŸ¥ Running health check..."
        sleep 15
        
        # Check if container is running
        if docker ps | grep -q recipe-frontend; then
          echo "âœ… Frontend container is running"
          docker ps | grep recipe-frontend
        else
          echo "âŒ Frontend container not found"
          docker compose logs
          exit 1
        fi